<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FastTrack Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      :root {
        color-scheme: only light;
        --ink: #0a0e27;
        --ink-soft: #475569;
        --ink-lighter: #94a3b8;
        --paper: #fafbfc;
        --card: #ffffff;
        --accent: #4f46e5;
        --accent-bright: #6366f1;
        --accent-light: #eef2ff;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --radius-2xl: 24px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        color: var(--ink);
        background: var(--paper);
        background-image: 
          radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.05) 0px, transparent 50%),
          radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.05) 0px, transparent 50%),
          radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.05) 0px, transparent 50%);
        min-height: 100vh;
        overflow-x: hidden;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Animated background grain */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.03;
        z-index: 0;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        animation: grain 8s steps(10) infinite;
      }

      @keyframes grain {
        0%, 100% { transform: translate(0, 0); }
        10% { transform: translate(-5%, -10%); }
        20% { transform: translate(-15%, 5%); }
        30% { transform: translate(7%, -25%); }
        40% { transform: translate(-5%, 25%); }
        50% { transform: translate(-15%, 10%); }
        60% { transform: translate(15%, 0%); }
        70% { transform: translate(0%, 15%); }
        80% { transform: translate(3%, 35%); }
        90% { transform: translate(-10%, 10%); }
      }

      .page {
        position: relative;
        z-index: 1;
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 24px 80px;
        animation: fadeIn 0.8s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Header */
      .site-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        flex-wrap: wrap;
        margin-bottom: 48px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
        animation: slideDown 0.6s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo-group {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .logo-mark {
        width: 52px;
        height: 52px;
        border-radius: var(--radius-lg);
        display: grid;
        place-items: center;
        font-weight: 700;
        font-size: 1.25rem;
        color: #fff;
        background: var(--gradient-1);
        box-shadow: var(--shadow-lg), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        letter-spacing: 0.05em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .logo-mark:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: var(--shadow-xl), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      }

      .logo-text {
        display: grid;
        gap: 2px;
      }

      .logo-text strong {
        font-family: "Playfair Display", serif;
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, var(--ink) 0%, var(--ink-soft) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .logo-text span {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--ink-lighter);
        font-weight: 600;
      }

      .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .status {
        font-size: 0.875rem;
        color: var(--ink-soft);
        padding: 8px 16px;
        background: var(--card);
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.15);
        font-weight: 500;
      }

      .chip {
        background: var(--accent-light);
        color: var(--accent);
        padding: 8px 16px;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 600;
        border: 1px solid rgba(79, 70, 229, 0.15);
        transition: all 0.2s ease;
      }

      .chip:hover {
        background: var(--accent);
        color: white;
        transform: translateY(-1px);
      }

      .btn {
        border: none;
        background: var(--accent);
        color: #fff;
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn:hover {
        background: var(--accent-bright);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .btn:active {
        transform: translateY(0);
      }

      /* Top Grid */
      .top-grid {
        display: grid;
        grid-template-columns: 1.4fr 1fr;
        gap: 24px;
        align-items: start;
        margin-bottom: 32px;
        animation: fadeInUp 0.8s ease-out 0.1s backwards;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Current Fast Card */
      .current-fast {
        background: var(--card);
        border-radius: var(--radius-2xl);
        padding: 32px;
        box-shadow: var(--shadow-xl);
        border: 1px solid rgba(148, 163, 184, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .current-fast::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-1);
      }

      .current-fast:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-2xl);
      }

      .current-fast h2 {
        font-family: "Playfair Display", serif;
        margin: 0 0 24px 0;
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .current-fast-content {
        display: grid;
        gap: 24px;
      }

      .current-fast-meta {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .current-fast-meta span {
        font-size: 0.8125rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--ink-lighter);
        font-weight: 600;
      }

      .current-fast-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .metric-box {
        background: linear-gradient(135deg, var(--paper) 0%, rgba(249, 250, 251, 0.5) 100%);
        padding: 16px;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(148, 163, 184, 0.1);
      }

      .metric-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--ink-lighter);
        font-weight: 600;
        margin-bottom: 4px;
      }

      .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        background: var(--gradient-1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-family: "Playfair Display", serif;
      }

      .progress {
        position: relative;
        width: 100%;
        height: 10px;
        border-radius: var(--radius-md);
        background: rgba(79, 70, 229, 0.1);
        overflow: hidden;
        margin-top: 12px;
      }

      .progress span {
        position: absolute;
        inset: 0;
        width: 0%;
        background: var(--gradient-1);
        border-radius: var(--radius-md);
        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 10px rgba(79, 70, 229, 0.3);
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .stat-card {
        background: var(--card);
        border-radius: var(--radius-xl);
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(148, 163, 184, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 3px;
        height: 100%;
        background: var(--gradient-1);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .stat-card:hover::before {
        opacity: 1;
      }

      .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--ink-lighter);
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--ink);
        font-family: "Playfair Display", serif;
      }

      /* Bottom Grid */
      .bottom-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-bottom: 32px;
        animation: fadeInUp 0.8s ease-out 0.2s backwards;
      }

      /* Chart Cards */
      .card {
        background: var(--card);
        border-radius: var(--radius-2xl);
        padding: 32px;
        box-shadow: var(--shadow-xl);
        border: 1px solid rgba(148, 163, 184, 0.1);
        transition: all 0.3s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-2xl);
      }

      .card h3 {
        font-family: "Playfair Display", serif;
        margin: 0 0 24px 0;
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: -0.01em;
        color: var(--ink);
      }

      .chart-container {
        position: relative;
        height: 280px;
      }

      /* Table */
      .table-card {
        grid-column: 1 / -1;
        animation: fadeInUp 0.8s ease-out 0.3s backwards;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }

      thead tr {
        background: linear-gradient(135deg, var(--paper) 0%, rgba(249, 250, 251, 0.5) 100%);
      }

      th {
        text-align: left;
        padding: 16px;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--ink-lighter);
        font-weight: 700;
        border-bottom: 2px solid rgba(148, 163, 184, 0.15);
      }

      th:first-child {
        border-top-left-radius: var(--radius-lg);
      }

      th:last-child {
        border-top-right-radius: var(--radius-lg);
      }

      td {
        padding: 16px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.08);
        font-size: 0.9375rem;
        color: var(--ink-soft);
      }

      tbody tr {
        transition: all 0.2s ease;
      }

      tbody tr:hover {
        background: rgba(79, 70, 229, 0.03);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:last-child td:first-child {
        border-bottom-left-radius: var(--radius-lg);
      }

      tbody tr:last-child td:last-child {
        border-bottom-right-radius: var(--radius-lg);
      }

      /* Footer */
      .page-footer {
        text-align: center;
        padding: 24px;
        color: var(--ink-lighter);
        font-size: 0.875rem;
        animation: fadeIn 1s ease-out 0.5s backwards;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .top-grid,
        .bottom-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .current-fast-metrics {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 640px) {
        .page {
          padding: 24px 16px 64px;
        }

        .site-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-actions {
          width: 100%;
          justify-content: space-between;
        }

        .logo-text strong {
          font-size: 1.5rem;
        }

        .current-fast,
        .card {
          padding: 24px;
        }

        .chart-container {
          height: 240px;
        }
      }

      /* Loading state */
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .loading {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Smooth scrolling */
      html {
        scroll-behavior: smooth;
      }

      /* Selection */
      ::selection {
        background: rgba(79, 70, 229, 0.2);
        color: var(--ink);
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="site-header">
        <div class="logo-group">
          <div class="logo-mark">FT</div>
          <div class="logo-text">
            <strong>FastTrack</strong>
            <span>Analytics</span>
          </div>
        </div>
        <div class="header-actions">
          <div class="status" id="statusText">Initializing...</div>
          <div class="chip">Live Dashboard</div>
          <button class="btn" id="refreshBtn">Refresh Data</button>
        </div>
      </header>

      <div class="top-grid">
        <div class="current-fast">
          <h2 id="currentFastTitle">Fast in progress</h2>
          <div class="current-fast-content">
            <div class="current-fast-meta">
              <span id="currentFastStart">Started recently</span>
            </div>
            <div class="current-fast-metrics">
              <div class="metric-box">
                <div class="metric-label">Elapsed</div>
                <div class="metric-value" id="currentFastElapsed">--</div>
              </div>
              <div class="metric-box">
                <div class="metric-label" id="currentFastGoal">Goal: --</div>
                <div class="metric-value" id="currentFastDelta">--</div>
              </div>
            </div>
            <div class="progress">
              <span id="currentFastProgress"></span>
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <span class="stat-label">Total Fasts</span>
            <div class="stat-value" id="statTotal">--</div>
          </div>
          <div class="stat-card">
            <span class="stat-label">Average Duration</span>
            <div class="stat-value" id="statAverage">--</div>
          </div>
          <div class="stat-card">
            <span class="stat-label">Longest Fast</span>
            <div class="stat-value" id="statLongest">--</div>
          </div>
          <div class="stat-card">
            <span class="stat-label">Goal Success</span>
            <div class="stat-value" id="statGoalRate">--</div>
          </div>
          <div class="stat-card">
            <span class="stat-label">7-Day Average</span>
            <div class="stat-value" id="statRolling">--</div>
          </div>
          <div class="stat-card">
            <span class="stat-label">Total Hours</span>
            <div class="stat-value" id="statTotalHours">--</div>
          </div>
        </div>
      </div>

      <div class="bottom-grid">
        <div class="card">
          <h3>Progress Timeline</h3>
          <div class="chart-container">
            <canvas id="progressChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h3>Duration Distribution</h3>
          <div class="chart-container">
            <canvas id="distributionChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card table-card">
        <h3>Recent Activity</h3>
        <table>
          <thead>
            <tr>
              <th>Date Completed</th>
              <th>Duration</th>
              <th>Goal</th>
              <th>vs Goal</th>
            </tr>
          </thead>
          <tbody id="recentTable">
            <tr>
              <td colspan="4" style="text-align: center; padding: 32px; color: var(--ink-lighter);">
                Loading data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <footer class="page-footer">
        <p>Last updated: <span id="lastUpdated">--</span></p>
      </footer>
    </div>

    <script>
      const SHEET_ID = "1XpNZRXhYQyuFvawL90dMoIbEE2x9Y5gB-M49OV9iy4Q";
      const SHEET_NAME = "Sheet1";

      const refreshBtn = document.getElementById("refreshBtn");
      const state = {
        charts: {
          progress: null,
          distribution: null,
        },
      };

      function setStatus(message) {
        document.getElementById("statusText").textContent = message;
      }

      function csvToRows(csv) {
        const rows = [];
        let currentRow = [];
        let currentCell = "";
        let insideQuotes = false;

        for (let i = 0; i < csv.length; i++) {
          const char = csv[i];
          const nextChar = csv[i + 1];

          if (char === '"') {
            if (insideQuotes && nextChar === '"') {
              currentCell += '"';
              i++;
            } else {
              insideQuotes = !insideQuotes;
            }
          } else if (char === "," && !insideQuotes) {
            currentRow.push(currentCell);
            currentCell = "";
          } else if (char === "\n" && !insideQuotes) {
            currentRow.push(currentCell);
            rows.push(currentRow);
            currentRow = [];
            currentCell = "";
            if (nextChar === "\r") i++;
          } else if (char === "\r" && nextChar === "\n" && !insideQuotes) {
            currentRow.push(currentCell);
            rows.push(currentRow);
            currentRow = [];
            currentCell = "";
            i++;
          } else {
            currentCell += char;
          }
        }

        if (currentCell || currentRow.length > 0) {
          currentRow.push(currentCell);
          rows.push(currentRow);
        }

        return rows.filter((row) => row.some((cell) => cell.trim()));
      }

      function parseSheetDate(dateStr) {
        if (!dateStr || !dateStr.trim()) return null;
        const parsed = new Date(dateStr.trim());
        return isNaN(parsed.getTime()) ? null : parsed;
      }

      function parseSheetTime(timeStr) {
        if (!timeStr || !timeStr.trim()) return null;
        const match = timeStr.trim().match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?$/i);
        if (!match) return null;
        let [, hours, minutes, seconds = "0", meridian] = match;
        hours = parseInt(hours, 10);
        minutes = parseInt(minutes, 10);
        seconds = parseInt(seconds, 10);
        if (meridian) {
          if (meridian.toUpperCase() === "PM" && hours < 12) hours += 12;
          if (meridian.toUpperCase() === "AM" && hours === 12) hours = 0;
        }
        return { hours, minutes, seconds };
      }

      function combineDateTime(dateStr, timeStr) {
        const date = parseSheetDate(dateStr);
        if (!date) return null;
        const time = parseSheetTime(timeStr);
        if (!time) return date;
        date.setHours(time.hours, time.minutes, time.seconds, 0);
        return date;
      }

      function parseDurationToHours(durationStr) {
        if (!durationStr || !durationStr.trim()) return null;
        const match = durationStr.trim().match(/^(\d+):(\d{2})$/);
        if (!match) return null;
        const [, hours, minutes] = match;
        return parseInt(hours, 10) + parseInt(minutes, 10) / 60;
      }

      function formatHours(hours) {
        if (hours == null || isNaN(hours)) return "--";
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return `${h}h ${m}m`;
      }

      function formatDelta(delta) {
        const sign = delta >= 0 ? "+" : "";
        return `${sign}${formatHours(delta)}`;
      }

      function formatShortDate(date) {
        if (!date) return "--";
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${month}/${day}`;
      }

      function formatFullDate(date) {
        if (!date) return "--";
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function buildCharts(entries) {
        if (!entries.length) return;

        if (state.charts.progress) state.charts.progress.destroy();
        if (state.charts.distribution) state.charts.distribution.destroy();

        const progressData = entries.slice(-12).map((entry, i) => ({
          x: i + 1,
          y: entry.durationHours,
          goal: entry.goalHours,
        }));

        const progressCtx = document.getElementById("progressChart").getContext("2d");
        state.charts.progress = new Chart(progressCtx, {
          type: "line",
          data: {
            labels: progressData.map((d) => `#${d.x}`),
            datasets: [
              {
                label: "Fast Duration",
                data: progressData.map((d) => d.y),
                borderColor: "rgb(79, 70, 229)",
                backgroundColor: "rgba(79, 70, 229, 0.1)",
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: "rgb(79, 70, 229)",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
              {
                label: "Goal",
                data: progressData.map((d) => d.goal),
                borderColor: "rgb(16, 185, 129)",
                backgroundColor: "rgba(16, 185, 129, 0.05)",
                tension: 0.4,
                fill: false,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: "rgb(16, 185, 129)",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
                borderDash: [5, 5],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  usePointStyle: true,
                  padding: 15,
                  font: {
                    family: "Inter",
                    size: 12,
                    weight: 600,
                  },
                },
              },
              tooltip: {
                backgroundColor: "rgba(10, 14, 39, 0.95)",
                padding: 12,
                titleFont: {
                  family: "Inter",
                  size: 13,
                  weight: 600,
                },
                bodyFont: {
                  family: "Inter",
                  size: 12,
                },
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                  label: (context) => {
                    const label = context.dataset.label || "";
                    const value = formatHours(context.parsed.y);
                    return `${label}: ${value}`;
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  font: {
                    family: "Inter",
                    size: 11,
                  },
                  color: "rgb(148, 163, 184)",
                },
                grid: {
                  color: "rgba(148, 163, 184, 0.1)",
                },
              },
              x: {
                ticks: {
                  font: {
                    family: "Inter",
                    size: 11,
                  },
                  color: "rgb(148, 163, 184)",
                },
                grid: {
                  display: false,
                },
              },
            },
          },
        });

        const distribution = [0, 12, 16, 20, 24, 36, 48];
        const buckets = distribution.map(() => 0);

        entries.forEach((entry) => {
          const hours = entry.durationHours;
          let index = distribution.findIndex((limit) => hours < limit);
          if (index === -1) index = distribution.length - 1;
          buckets[index] += 1;
        });

        const bucketLabels = [
          "<12h",
          "12-16h",
          "16-20h",
          "20-24h",
          "24-36h",
          "36-48h",
          "48h+",
        ];

        const distCtx = document.getElementById("distributionChart").getContext("2d");
        state.charts.distribution = new Chart(distCtx, {
          type: "doughnut",
          data: {
            labels: bucketLabels,
            datasets: [
              {
                data: buckets,
                backgroundColor: [
                  "rgba(99, 102, 241, 0.9)",
                  "rgba(139, 92, 246, 0.9)",
                  "rgba(168, 85, 247, 0.9)",
                  "rgba(236, 72, 153, 0.9)",
                  "rgba(16, 185, 129, 0.9)",
                  "rgba(59, 130, 246, 0.9)",
                  "rgba(245, 158, 11, 0.9)",
                ],
                borderWidth: 0,
                hoverOffset: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  usePointStyle: true,
                  padding: 12,
                  font: {
                    family: "Inter",
                    size: 12,
                    weight: 600,
                  },
                },
              },
              tooltip: {
                backgroundColor: "rgba(10, 14, 39, 0.95)",
                padding: 12,
                titleFont: {
                  family: "Inter",
                  size: 13,
                  weight: 600,
                },
                bodyFont: {
                  family: "Inter",
                  size: 12,
                },
                cornerRadius: 8,
                callbacks: {
                  label: (context) => `${context.label}: ${context.raw} fasts`,
                },
              },
            },
          },
        });
      }

      function buildInsights(entries) {
        if (!entries.length) return;

        const totalHours = entries.reduce((sum, entry) => sum + entry.durationHours, 0);
        const average = totalHours / entries.length;
        const longest = Math.max(...entries.map((entry) => entry.durationHours));

        const goals = entries.filter((entry) => entry.goalHours !== null);
        const goalHits = goals.filter((entry) => entry.durationHours >= entry.goalHours);
        const goalRate = goals.length ? (goalHits.length / goals.length) * 100 : null;

        const rolling = entries.slice(-7);
        const rollingAvg =
          rolling.length > 0
            ? rolling.reduce((sum, entry) => sum + entry.durationHours, 0) / rolling.length
            : null;

        const recent = entries[entries.length - 1];

        document.getElementById("statTotal").textContent = entries.length.toString();
        document.getElementById("statAverage").textContent = formatHours(average);
        document.getElementById("statLongest").textContent = formatHours(longest);
        document.getElementById("statGoalRate").textContent = goalRate
          ? `${Math.round(goalRate)}%`
          : "--";
        document.getElementById("statRolling").textContent = formatHours(rollingAvg);
        document.getElementById("statTotalHours").textContent = formatHours(totalHours);

        document.getElementById("lastUpdated").textContent = formatFullDate(
          recent.endDate || recent.startDate
        );
      }

      function buildRecentTable(entries) {
        const table = document.getElementById("recentTable");
        table.innerHTML = "";
        const recent = entries.slice(-6).reverse();
        
        if (recent.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td colspan="4" style="text-align: center; padding: 32px; color: var(--ink-lighter);">
              No completed fasts yet
            </td>
          `;
          table.appendChild(row);
          return;
        }

        recent.forEach((entry) => {
          const row = document.createElement("tr");
          const delta =
            entry.goalHours !== null ? entry.durationHours - entry.goalHours : null;
          row.innerHTML = `
            <td>${formatFullDate(entry.endDate || entry.startDate)}</td>
            <td><strong>${formatHours(entry.durationHours)}</strong></td>
            <td>${entry.goalHours !== null ? formatHours(entry.goalHours) : "--"}</td>
            <td style="color: ${delta !== null ? (delta >= 0 ? 'var(--success)' : 'var(--danger)') : 'var(--ink-lighter)'}">${delta !== null ? formatDelta(delta) : "--"}</td>
          `;
          table.appendChild(row);
        });
      }

      async function fetchSheetCsv() {
        const urls = [
          `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(
            SHEET_NAME
          )}`,
          `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`,
        ];

        for (const url of urls) {
          try {
            const response = await fetch(url, { cache: "no-store" });
            if (!response.ok) continue;
            const text = await response.text();
            if (text && text.includes(",")) return text;
          } catch (error) {
            console.warn("Sheet fetch failed", error);
          }
        }
        throw new Error("Unable to load sheet data.");
      }

      function normalizeEntries(rows) {
        if (!rows.length) return [];
        const headers = rows[0].map((header) => header.trim());
        const dataRows = rows.slice(1).filter((row) =>
          row.some((cell) => cell && cell.toString().trim())
        );

        const entries = dataRows.map((row) => {
          const record = {};
          headers.forEach((header, index) => {
            record[header] = row[index] ?? "";
          });

          const startDate =
            parseSheetDate(record["Fast Start D+T"]) ||
            combineDateTime(record["Fast Start Date"], record["Fast Start Time"]);
          const endDate =
            parseSheetDate(record["Fast End D+T"]) ||
            combineDateTime(record["Fast End Date"], record["Fast End"]);
          const durationHours =
            parseDurationToHours(record["Duration"]) ||
            (startDate && endDate ? (endDate - startDate) / 36e5 : null);
          const goalHours = parseDurationToHours(record["New Fasting Goal"]);

          return {
            startDate,
            endDate,
            durationHours,
            goalHours,
          };
        });

        return entries
          .filter((entry) => entry.startDate || entry.endDate)
          .sort((a, b) => {
            const aTime = (a.startDate || a.endDate || new Date(0)).getTime();
            const bTime = (b.startDate || b.endDate || new Date(0)).getTime();
            return aTime - bTime;
          });
      }

      function getCurrentFast(entries) {
        const starts = entries.filter((entry) => entry.startDate);
        if (!starts.length) return null;
        const latestStart = starts.reduce((latest, entry) =>
          entry.startDate > latest.startDate ? entry : latest
        );
        const hasEndAfterStart = entries.some(
          (entry) => entry.endDate && entry.endDate >= latestStart.startDate
        );
        return hasEndAfterStart ? null : latestStart;
      }

      function updateCurrentFast(entry) {
        const title = document.getElementById("currentFastTitle");
        const startLabel = document.getElementById("currentFastStart");
        const elapsedEl = document.getElementById("currentFastElapsed");
        const goalEl = document.getElementById("currentFastGoal");
        const deltaEl = document.getElementById("currentFastDelta");
        const progressEl = document.getElementById("currentFastProgress");

        if (!entry || !entry.startDate) {
          title.textContent = "No active fast";
          startLabel.textContent = "Start a new fast to see progress";
          elapsedEl.textContent = "--";
          goalEl.textContent = "Goal: --";
          deltaEl.textContent = "--";
          progressEl.style.width = "0%";
          return;
        }

        const now = new Date();
        const elapsedHours = Math.max(0, (now - entry.startDate) / 36e5);
        const goalHours = entry.goalHours;
        const hasGoal = Number.isFinite(goalHours) && goalHours > 0;
        const progress = hasGoal ? Math.min(elapsedHours / goalHours, 1) : 0;
        const remaining = hasGoal ? goalHours - elapsedHours : null;

        title.textContent = "Fast in progress";
        startLabel.textContent = `Started ${formatFullDate(entry.startDate)}`;
        elapsedEl.textContent = formatHours(elapsedHours);
        goalEl.textContent = hasGoal ? `Goal: ${formatHours(goalHours)}` : "Goal: --";
        if (remaining === null) {
          deltaEl.textContent = "No goal set";
        } else if (remaining >= 0) {
          deltaEl.textContent = `${formatHours(remaining)} left`;
        } else {
          deltaEl.textContent = `${formatHours(Math.abs(remaining))} over`;
        }
        progressEl.style.width = `${Math.round(progress * 100)}%`;
      }

      async function loadDashboard() {
        setStatus("Loading data...");
        try {
          const csv = await fetchSheetCsv();
          const rows = csvToRows(csv);
          const entries = normalizeEntries(rows);
          const currentFast = getCurrentFast(entries);
          const completedEntries = entries.filter(
            (entry) =>
              entry.durationHours !== null &&
              !Number.isNaN(entry.durationHours) &&
              entry !== currentFast
          );

          if (!entries.length) {
            setStatus("No data found in the sheet.");
            return;
          }

          buildCharts(completedEntries);
          buildInsights(completedEntries);
          buildRecentTable(completedEntries);
          updateCurrentFast(currentFast);
          setStatus("Live data loaded");
        } catch (error) {
          console.error(error);
          setStatus("Unable to fetch sheet data");
        }
      }

      refreshBtn.addEventListener("click", () => loadDashboard());
      loadDashboard();
    </script>
  </body>
</html>
