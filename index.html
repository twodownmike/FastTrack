<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FastTrack Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fraunces:wght@300;400;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      :root {
        color-scheme: only light;
        --ink: #0e1b1f;
        --ink-soft: #2b4249;
        --paper: #f8f5f0;
        --card: #ffffff;
        --accent: #0d6d6b;
        --accent-bright: #1ea49b;
        --sun: #f49f3f;
        --rose: #e56a5b;
        --mint: #c7f1e9;
        --sky: #d8e9f9;
        --shadow: 0 18px 55px rgba(14, 27, 31, 0.12);
        --radius-lg: 26px;
        --radius-md: 18px;
        --radius-sm: 12px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, sans-serif;
        color: var(--ink);
        background: linear-gradient(120deg, #fff4df 0%, #f1f7ff 38%, #e6fff5 100%);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .ambient {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
      }

      .orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(1px);
        opacity: 0.6;
        animation: float 18s ease-in-out infinite;
      }

      .orb.orb-1 {
        width: 320px;
        height: 320px;
        background: radial-gradient(circle at 30% 30%, #fff5d8, #ffd8a8);
        top: -80px;
        left: -120px;
      }

      .orb.orb-2 {
        width: 260px;
        height: 260px;
        background: radial-gradient(circle at 40% 40%, #e0f7ff, #b6e9ff);
        top: 80px;
        right: -100px;
        animation-delay: -4s;
      }

      .orb.orb-3 {
        width: 220px;
        height: 220px;
        background: radial-gradient(circle at 50% 50%, #e6ffe9, #b8f2d2);
        bottom: -60px;
        left: 10%;
        animation-delay: -9s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translate3d(0, 0, 0);
        }
        50% {
          transform: translate3d(0, 20px, 0);
        }
      }

      .page {
        position: relative;
        z-index: 1;
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 18px 48px;
      }

      .top-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 18px;
        align-items: stretch;
        margin-bottom: 28px;
        animation: rise 0.8s ease forwards;
      }

      .site-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        flex-wrap: wrap;
        margin-bottom: 22px;
        animation: fadeUp 0.7s ease both;
        flex-direction: column;
        align-items: flex-start;
      }

      .logo-group {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .logo-mark {
        width: 46px;
        height: 46px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        font-weight: 700;
        color: #fff;
        background: linear-gradient(135deg, #0d6d6b, #1ea49b);
        box-shadow: 0 10px 20px rgba(13, 109, 107, 0.25);
        letter-spacing: 0.08em;
        animation: logoPulse 6s ease-in-out infinite;
      }

      .logo-text {
        display: grid;
        gap: 2px;
      }

      .logo-text strong {
        font-family: "Fraunces", serif;
        font-size: 1.4rem;
      }

      .logo-text span {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.26em;
        color: var(--ink-soft);
      }

      .header-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 14px;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
      }

      .header-actions .status {
        font-size: 0.85rem;
      }

      .header-actions .status:last-child {
        white-space: normal;
      }

      .current-fast {
        background: linear-gradient(120deg, #fff2d6 0%, #e8fff7 100%);
        border-radius: var(--radius-lg);
        padding: 18px 22px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        box-shadow: 0 12px 28px rgba(14, 27, 31, 0.12);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      .current-fast:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 34px rgba(14, 27, 31, 0.16);
      }

      .current-fast h2 {
        font-family: "Fraunces", serif;
        margin: 0;
        font-size: 1.2rem;
      }

      .current-fast-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 220px;
      }

      .current-fast-meta span {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--ink-soft);
      }

      .current-fast-metrics {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 200px;
      }

      .current-fast-metrics strong {
        font-size: 1.3rem;
      }

      .progress {
        position: relative;
        width: 100%;
        height: 12px;
        border-radius: 999px;
        background: rgba(13, 109, 107, 0.15);
        overflow: hidden;
      }

      .progress span {
        position: absolute;
        inset: 0;
        width: 0%;
        background: linear-gradient(90deg, #0d6d6b, #1ea49b);
        border-radius: 999px;
        transition: width 0.6s ease;
        background-size: 200% 100%;
        animation: progressShift 6s ease-in-out infinite;
      }

      .milestones {
        width: 100%;
        display: grid;
        gap: 8px;
        margin-top: 6px;
      }

      .milestones-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--ink-soft);
      }

      .milestones-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .milestone {
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.72rem;
        font-weight: 600;
        letter-spacing: 0.04em;
        background: rgba(14, 27, 31, 0.08);
        color: var(--ink-soft);
      }

      .milestone.done {
        background: rgba(13, 109, 107, 0.2);
        color: var(--accent);
      }

      .milestone.current {
        background: #0d6d6b;
        color: #fff;
        box-shadow: 0 8px 18px rgba(13, 109, 107, 0.25);
      }

      .milestone.muted {
        font-weight: 500;
      }

      @keyframes rise {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chip {
        background: rgba(13, 109, 107, 0.12);
        color: var(--accent);
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .btn {
        border: none;
        background: var(--accent);
        color: #fff;
        padding: 12px 18px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 10px 18px rgba(13, 109, 107, 0.2);
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 24px rgba(13, 109, 107, 0.28);
      }

      .status {
        font-size: 0.9rem;
        color: var(--ink-soft);
      }

      .hero-panel {
        background: var(--card);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow);
        display: grid;
        gap: 16px;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      .hero-panel:hover {
        transform: translateY(-2px);
        box-shadow: 0 22px 52px rgba(14, 27, 31, 0.14);
      }

      .hero-panel h2 {
        font-family: "Fraunces", serif;
        margin: 0;
        font-size: 1.3rem;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .stat-card {
        background: var(--paper);
        border-radius: var(--radius-md);
        padding: 14px 16px;
        display: grid;
        gap: 6px;
        transition: transform 0.2s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-card span {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--ink-soft);
      }

      .stat-card strong {
        font-size: 1.2rem;
      }

      .dashboard {
        margin-top: 42px;
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 18px;
      }

      .card {
        background: var(--card);
        border-radius: var(--radius-lg);
        padding: 22px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 12px;
        animation: fadeUp 0.7s ease both;
        animation-delay: var(--delay, 0s);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 24px 60px rgba(14, 27, 31, 0.16);
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(14px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes logoPulse {
        0%,
        100% {
          transform: translateY(0);
          box-shadow: 0 10px 20px rgba(13, 109, 107, 0.25);
        }
        50% {
          transform: translateY(-2px);
          box-shadow: 0 16px 30px rgba(13, 109, 107, 0.3);
        }
      }

      @keyframes progressShift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .card h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .card p {
        margin: 0;
        color: var(--ink-soft);
      }

      .chart {
        position: relative;
        height: 260px;
        width: 100%;
      }

      .chart canvas {
        width: 100%;
        height: 100%;
      }

      .card-wide {
        grid-column: span 1;
      }

      .card-mid {
        grid-column: span 1;
      }

      .card-half {
        grid-column: span 1;
      }

      .card-full {
        grid-column: span 1;
      }

      .insights {
        display: grid;
        gap: 10px;
      }

      .streak-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
      }

      .recap-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
      }

      .insight {
        background: linear-gradient(120deg, #fff2d6, #f2fff9);
        border-radius: var(--radius-md);
        padding: 12px 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 500;
      }

      .insight span {
        color: var(--ink-soft);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .recent-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }

      .recent-table th,
      .recent-table td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid rgba(14, 27, 31, 0.08);
      }

      .recent-table th {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--ink-soft);
      }

      .heatmap {
        display: grid;
        grid-template-columns: repeat(14, minmax(0, 1fr));
        gap: 6px;
      }

      .heatmap-cell {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 6px;
        background: rgba(13, 109, 107, 0.1);
        transition: transform 0.2s ease;
      }

      .heatmap-cell:hover {
        transform: scale(1.08);
      }

      .heat-0 {
        background: rgba(13, 109, 107, 0.08);
      }

      .heat-1 {
        background: rgba(13, 109, 107, 0.28);
      }

      .heat-2 {
        background: rgba(30, 164, 155, 0.45);
      }

      .heat-3 {
        background: rgba(30, 164, 155, 0.7);
      }

      .heat-4 {
        background: #0d6d6b;
      }

      .heatmap-legend {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.8rem;
        color: var(--ink-soft);
      }

      .heatmap-swatch {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      .heatmap-swatch .heatmap-cell {
        width: 14px;
        height: 14px;
        aspect-ratio: auto;
      }

      footer {
        margin-top: 36px;
        color: var(--ink-soft);
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
      }

      @media (min-width: 720px) {
        .page {
          padding: 40px 24px 56px;
        }

        .site-header {
          flex-direction: row;
          align-items: center;
        }

        .header-actions {
          width: auto;
          justify-content: flex-end;
        }

        .dashboard {
          grid-template-columns: repeat(6, minmax(0, 1fr));
          gap: 20px;
        }

        .card-wide,
        .card-mid,
        .card-full {
          grid-column: span 6;
        }

        .card-half {
          grid-column: span 3;
        }
      }

      @media (min-width: 1024px) {
        .page {
          padding: 52px 32px 70px;
        }

        .top-grid {
          grid-template-columns: minmax(0, 1.35fr) minmax(0, 0.95fr);
          gap: 22px;
        }

        .dashboard {
          grid-template-columns: repeat(12, minmax(0, 1fr));
        }

        .card-wide {
          grid-column: span 7;
        }

        .card-mid {
          grid-column: span 5;
        }

        .card-half {
          grid-column: span 4;
        }

        .card-full {
          grid-column: span 12;
        }
      }
    </style>
  </head>
  <body>
    <div class="ambient">
      <span class="orb orb-1"></span>
      <span class="orb orb-2"></span>
      <span class="orb orb-3"></span>
    </div>

    <div class="page">
      <div class="site-header">
        <div class="logo-group">
          <div class="logo-mark">FT</div>
          <div class="logo-text">
            <strong>FastTrack</strong>
            <span>Fasting Metrics</span>
          </div>
        </div>
        <div class="header-actions">
          <span class="chip">Source: Google Sheets</span>
          <button class="btn" id="refreshBtn">Refresh Data</button>
          <span class="status" id="statusText">Ready.</span>
          <span class="status">Last refresh: <span id="lastUpdated">--</span></span>
        </div>
      </div>
      <section class="top-grid">
        <div class="current-fast">
          <div class="current-fast-meta">
            <span>Current Fast</span>
            <h2 id="currentFastTitle">No active fast</h2>
            <div class="status" id="currentFastStart">--</div>
          </div>
          <div class="current-fast-metrics">
            <strong id="currentFastElapsed">--</strong>
            <div class="status" id="currentFastGoal">Goal: --</div>
            <div class="status" id="currentFastDelta">--</div>
            <div class="progress">
              <span id="currentFastProgress"></span>
            </div>
          </div>
          <div class="milestones">
            <div class="milestones-label">Phases</div>
            <div class="milestones-row" id="fastMilestones"></div>
          </div>
        </div>
        <div class="hero-panel">
          <h2>Snapshot</h2>
          <div class="stat-grid">
            <div class="stat-card">
              <span>Total Fasts</span>
              <strong id="statTotal">--</strong>
            </div>
            <div class="stat-card">
              <span>Average Duration</span>
              <strong id="statAverage">--</strong>
            </div>
            <div class="stat-card">
              <span>Longest Fast</span>
              <strong id="statLongest">--</strong>
            </div>
            <div class="stat-card">
              <span>Goal Hit Rate</span>
              <strong id="statGoalRate">--</strong>
            </div>
          </div>
          <div class="stat-card" style="background: #fff4e6">
            <span>Most Recent Fast</span>
            <strong id="statRecent">--</strong>
          </div>
        </div>
      </section>

      <main class="dashboard">
        <section class="card card-wide" style="--delay: 0.1s">
          <h3>Duration Over Time</h3>
          <p>Track every completed fast from start to finish.</p>
          <div class="chart">
            <canvas id="durationChart"></canvas>
          </div>
        </section>

        <section class="card card-mid" style="--delay: 0.15s">
          <h3>Goal vs. Actual</h3>
          <p>How close each fast came to your stated goal.</p>
          <div class="chart">
            <canvas id="goalChart"></canvas>
          </div>
        </section>

        <section class="card card-half" style="--delay: 0.2s">
          <h3>Duration Mix</h3>
          <p>Distribution of fast lengths.</p>
          <div class="chart">
            <canvas id="distributionChart"></canvas>
          </div>
        </section>

        <section class="card card-half" style="--delay: 0.22s">
          <h3>Streaks + Consistency</h3>
          <p>How consistent your fasting days have been.</p>
          <div class="streak-grid">
            <div class="stat-card">
              <span>Current Streak</span>
              <strong id="statStreakCurrent">--</strong>
            </div>
            <div class="stat-card">
              <span>Longest Streak</span>
              <strong id="statStreakLongest">--</strong>
            </div>
            <div class="stat-card">
              <span>30-Day Consistency</span>
              <strong id="statConsistency30">--</strong>
            </div>
            <div class="stat-card">
              <span>Days Since Last Fast</span>
              <strong id="statDaysSince">--</strong>
            </div>
          </div>
        </section>

        <section class="card card-half" style="--delay: 0.24s">
          <h3>Momentum</h3>
          <p>Rolling averages and consistency highlights.</p>
          <div class="insights">
            <div class="insight">
              <span>Rolling 7 Avg</span>
              <strong id="statRolling">--</strong>
            </div>
            <div class="insight">
              <span>Consistency</span>
              <strong id="statConsistency">--</strong>
            </div>
            <div class="insight">
              <span>Total Hours</span>
              <strong id="statTotalHours">--</strong>
            </div>
          </div>
        </section>

        <section class="card card-mid" style="--delay: 0.26s">
          <h3>Time of Day Patterns</h3>
          <p>When your fasts tend to start and end.</p>
          <div class="chart">
            <canvas id="timeChart"></canvas>
          </div>
        </section>

        <section class="card card-mid" style="--delay: 0.27s">
          <h3>Weekly Recap</h3>
          <p>Summary of the last 7 days.</p>
          <div class="recap-grid">
            <div class="stat-card">
              <span>Total Hours</span>
              <strong id="statWeeklyHours">--</strong>
            </div>
            <div class="stat-card">
              <span>Avg Duration</span>
              <strong id="statWeeklyAvg">--</strong>
            </div>
            <div class="stat-card">
              <span>Goal Hit Rate</span>
              <strong id="statWeeklyGoalRate">--</strong>
            </div>
            <div class="stat-card">
              <span>Fasts Logged</span>
              <strong id="statWeeklyCount">--</strong>
            </div>
          </div>
        </section>

        <section class="card card-wide" style="--delay: 0.29s">
          <h3>Calendar Heatmap</h3>
          <p>Last 14 weeks of fasting volume.</p>
          <div class="heatmap" id="heatmapGrid"></div>
          <div class="heatmap-legend">
            <span>Less</span>
            <div class="heatmap-swatch">
              <span class="heatmap-cell heat-0"></span>
              <span class="heatmap-cell heat-1"></span>
              <span class="heatmap-cell heat-2"></span>
              <span class="heatmap-cell heat-3"></span>
              <span class="heatmap-cell heat-4"></span>
            </div>
            <span>More</span>
          </div>
        </section>

        <section class="card card-full" style="--delay: 0.31s">
          <h3>Recent Fasts</h3>
          <p>Latest entries from your sheet.</p>
          <div style="overflow-x: auto">
            <table class="recent-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Duration</th>
                  <th>Goal</th>
                  <th>Delta</th>
                </tr>
              </thead>
              <tbody id="recentTable"></tbody>
            </table>
          </div>
        </section>
      </main>

      <footer>
        <div>
          Data pulls from columns A-O in your public Google Sheet. If charts are empty,
          confirm the sheet is shared to "Anyone with the link."
        </div>
      </footer>
    </div>

    <script>
      const SHEET_ID = "1AgRJFJfRu6lz_73qK8KNytFWQv9HrwwZnr5aeQfcy0M";
      const SHEET_NAME = "Form Responses 2";
      const state = { charts: {} };
      const FAST_PHASES = [
        { hours: 4, label: "Phase 1" },
        { hours: 8, label: "Phase 2" },
        { hours: 12, label: "Phase 3" },
        { hours: 16, label: "Phase 4" },
        { hours: 20, label: "Phase 5" },
        { hours: 24, label: "Phase 6" },
      ];

      const statusText = document.getElementById("statusText");
      const refreshBtn = document.getElementById("refreshBtn");

      function setStatus(message) {
        statusText.textContent = message;
      }

      function csvToRows(csv) {
        const rows = [];
        let row = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < csv.length; i += 1) {
          const char = csv[i];
          if (inQuotes) {
            if (char === '"') {
              if (csv[i + 1] === '"') {
                current += '"';
                i += 1;
              } else {
                inQuotes = false;
              }
            } else {
              current += char;
            }
          } else if (char === '"') {
            inQuotes = true;
          } else if (char === ",") {
            row.push(current);
            current = "";
          } else if (char === "\n") {
            row.push(current);
            rows.push(row);
            row = [];
            current = "";
          } else if (char !== "\r") {
            current += char;
          }
        }

        if (current.length || row.length) {
          row.push(current);
          rows.push(row);
        }
        return rows;
      }

      function parseNumber(value) {
        if (value === null || value === undefined) return null;
        const cleaned = value.toString().trim();
        if (!cleaned) return null;
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : null;
      }

      function parseDurationToHours(value) {
        if (!value) return null;
        const raw = value.toString().trim();
        if (!raw) return null;
        if (raw.includes(":")) {
          const parts = raw.split(":").map((item) => Number(item));
          if (parts.some((part) => Number.isNaN(part))) return null;
          const hours = parts[0] || 0;
          const minutes = parts[1] || 0;
          const seconds = parts[2] || 0;
          return hours + minutes / 60 + seconds / 3600;
        }

        const numeric = parseNumber(raw);
        if (numeric === null) return null;
        if (numeric <= 1.5) return numeric * 24;
        return numeric;
      }

      function parseSheetDate(value) {
        if (!value) return null;
        const raw = value.toString().trim();
        if (!raw) return null;
        const numeric = parseNumber(raw);
        if (numeric && numeric > 20000) {
          return new Date((numeric - 25569) * 86400 * 1000);
        }
        const parsed = new Date(raw);
        if (!Number.isNaN(parsed.getTime())) return parsed;

        const match = raw.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
        if (match) {
          const month = Number(match[1]) - 1;
          const day = Number(match[2]);
          const year = Number(match[3].length === 2 ? `20${match[3]}` : match[3]);
          return new Date(year, month, day);
        }
        return null;
      }

      function parseTimeParts(value) {
        if (!value) return null;
        const match = value
          .toString()
          .trim()
          .match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?/i);
        if (!match) return null;
        let hours = Number(match[1]);
        const minutes = Number(match[2]);
        const seconds = Number(match[3] || 0);
        const meridian = match[4];
        if (meridian) {
          const upper = meridian.toUpperCase();
          if (upper === "PM" && hours < 12) hours += 12;
          if (upper === "AM" && hours === 12) hours = 0;
        }
        return { hours, minutes, seconds };
      }

      function combineDateTime(dateValue, timeValue) {
        const date = parseSheetDate(dateValue);
        if (!date) return null;
        const time = parseTimeParts(timeValue);
        if (!time) return date;
        date.setHours(time.hours, time.minutes, time.seconds, 0);
        return date;
      }

      function formatShortDate(date) {
        if (!date) return "--";
        return new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
        }).format(date);
      }

      function formatFullDate(date) {
        if (!date) return "--";
        return new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        }).format(date);
      }

      function formatHours(hours) {
        if (hours === null || Number.isNaN(hours)) return "--";
        const totalMinutes = Math.round(hours * 60);
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        return `${h}h ${m}m`;
      }

      function formatDelta(delta) {
        if (delta === null || Number.isNaN(delta)) return "--";
        const sign = delta >= 0 ? "+" : "-";
        return `${sign}${formatHours(Math.abs(delta))}`;
      }

      function renderMilestones(elapsedHours) {
        const row = document.getElementById("fastMilestones");
        if (!row) return;
        row.innerHTML = "";

        if (elapsedHours === null || Number.isNaN(elapsedHours)) {
          const chip = document.createElement("span");
          chip.className = "milestone muted";
          chip.textContent = "Start a fast to see phases";
          row.appendChild(chip);
          return;
        }

        let currentSet = false;
        FAST_PHASES.forEach((phase) => {
          let status = "upcoming";
          if (elapsedHours >= phase.hours) {
            status = "done";
          } else if (!currentSet) {
            status = "current";
            currentSet = true;
          }

          const chip = document.createElement("span");
          chip.className = `milestone ${status}`;
          chip.textContent = `${phase.label} 路 ${phase.hours}h`;

          if (status === "done") {
            chip.title = `Reached at ${formatHours(phase.hours)}`;
          } else {
            const remaining = Math.max(0, phase.hours - elapsedHours);
            chip.title = `${formatHours(remaining)} to go`;
          }
          row.appendChild(chip);
        });
      }

      function toDay(date) {
        return new Date(date.getFullYear(), date.getMonth(), date.getDate());
      }

      function formatHourLabel(hour) {
        const period = hour < 12 ? "a" : "p";
        const normalized = hour % 12 || 12;
        return `${normalized}${period}`;
      }

      function getHeatLevel(hours) {
        if (hours >= 20) return 4;
        if (hours >= 16) return 3;
        if (hours >= 12) return 2;
        if (hours > 0) return 1;
        return 0;
      }

      function destroyCharts() {
        Object.values(state.charts).forEach((chart) => chart.destroy());
        state.charts = {};
      }

      function buildCharts(entries) {
        destroyCharts();
        if (!entries.length) return;

        const durations = entries.map((entry) => entry.durationHours);
        const labels = entries.map((entry) => formatShortDate(entry.endDate || entry.startDate));

        const recentEntries = entries.slice(-12);
        const recentLabels = recentEntries.map((entry) =>
          formatShortDate(entry.endDate || entry.startDate)
        );

        const durationCtx = document.getElementById("durationChart").getContext("2d");
        const gradient = durationCtx.createLinearGradient(0, 0, 0, 260);
        gradient.addColorStop(0, "rgba(30, 164, 155, 0.5)");
        gradient.addColorStop(1, "rgba(30, 164, 155, 0.05)");

        state.charts.duration = new Chart(durationCtx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Duration (hours)",
                data: durations,
                borderColor: "#0d6d6b",
                backgroundColor: gradient,
                borderWidth: 2,
                tension: 0.35,
                pointRadius: 3,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${formatHours(context.raw)}`,
                },
              },
            },
            scales: {
              y: {
                ticks: {
                  callback: (value) => {
                    const rounded = Math.round(Number(value) * 100) / 100;
                    return `${rounded.toFixed(2)}h`;
                  },
                },
                grid: { color: "rgba(14,27,31,0.06)" },
              },
              x: {
                grid: { display: false },
              },
            },
          },
        });

        const goalCtx = document.getElementById("goalChart").getContext("2d");
        state.charts.goal = new Chart(goalCtx, {
          type: "bar",
          data: {
            labels: recentLabels,
            datasets: [
              {
                label: "Duration",
                data: recentEntries.map((entry) => entry.durationHours),
                backgroundColor: "rgba(13, 109, 107, 0.75)",
                borderRadius: 10,
              },
              {
                label: "Goal",
                data: recentEntries.map((entry) => entry.goalHours ?? null),
                backgroundColor: "rgba(244, 159, 63, 0.75)",
                borderRadius: 10,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (context) =>
                    `${context.dataset.label}: ${formatHours(context.raw)}`,
                },
              },
            },
            scales: {
              y: {
                ticks: {
                  callback: (value) => `${value}h`,
                },
                grid: { color: "rgba(14,27,31,0.06)" },
              },
              x: {
                grid: { display: false },
              },
            },
          },
        });

        const bucketLabels = [
          "<12h",
          "12-16h",
          "16-20h",
          "20-24h",
          "24-36h",
          "36-48h",
          "48h+",
        ];
        const buckets = bucketLabels.map(() => 0);

        const bucketIndexFor = (hours) => {
          if (hours < 12) return 0;
          if (hours < 16) return 1;
          if (hours < 20) return 2;
          if (hours < 24) return 3;
          if (hours < 36) return 4;
          if (hours < 48) return 5;
          return 6;
        };

        entries.forEach((entry) => {
          const hours = entry.durationHours;
          if (hours === null || Number.isNaN(hours)) return;
          const index = bucketIndexFor(hours);
          buckets[index] += 1;
        });

        const distCtx = document.getElementById("distributionChart").getContext("2d");
        state.charts.distribution = new Chart(distCtx, {
          type: "doughnut",
          data: {
            labels: bucketLabels,
            datasets: [
              {
                data: buckets,
                backgroundColor: [
                  "#ffd59e",
                  "#ffc18a",
                  "#f4a66b",
                  "#e68064",
                  "#b5e2d7",
                  "#7cd4c2",
                  "#3aa8a1",
                ],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.label}: ${context.raw} fasts`,
                },
              },
            },
          },
        });
      }

      function buildTimePatterns(entries) {
        if (!entries.length) return;
        const startCounts = Array(24).fill(0);
        const endCounts = Array(24).fill(0);

        entries.forEach((entry) => {
          if (entry.startDate) startCounts[entry.startDate.getHours()] += 1;
          if (entry.endDate) endCounts[entry.endDate.getHours()] += 1;
        });

        const labels = startCounts.map((_, hour) => formatHourLabel(hour));
        const timeCtx = document.getElementById("timeChart").getContext("2d");

        state.charts.time = new Chart(timeCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Starts",
                data: startCounts,
                backgroundColor: "rgba(13, 109, 107, 0.7)",
                borderRadius: 8,
              },
              {
                label: "Ends",
                data: endCounts,
                backgroundColor: "rgba(244, 159, 63, 0.7)",
                borderRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${context.raw}`,
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 },
                grid: { color: "rgba(14,27,31,0.06)" },
              },
              x: {
                grid: { display: false },
              },
            },
          },
        });
      }

      function buildStreaks(entries) {
        const currentEl = document.getElementById("statStreakCurrent");
        const longestEl = document.getElementById("statStreakLongest");
        const consistencyEl = document.getElementById("statConsistency30");
        const sinceEl = document.getElementById("statDaysSince");

        if (!currentEl || !longestEl || !consistencyEl || !sinceEl) return;
        if (!entries.length) {
          currentEl.textContent = "--";
          longestEl.textContent = "--";
          consistencyEl.textContent = "--";
          sinceEl.textContent = "--";
          return;
        }

        const dayTotals = new Map();
        entries.forEach((entry) => {
          const baseDate = entry.endDate || entry.startDate;
          if (!baseDate) return;
          const dayMs = toDay(baseDate).getTime();
          const previous = dayTotals.get(dayMs) || 0;
          dayTotals.set(dayMs, previous + (entry.durationHours || 0));
        });

        const days = Array.from(dayTotals.keys()).sort((a, b) => a - b);
        if (!days.length) return;

        let longest = 0;
        let rolling = 0;
        let prev = null;
        days.forEach((dayMs) => {
          if (prev !== null && dayMs - prev === 86400000) {
            rolling += 1;
          } else {
            rolling = 1;
          }
          if (rolling > longest) longest = rolling;
          prev = dayMs;
        });

        let currentStreak = 1;
        for (let i = days.length - 1; i > 0; i -= 1) {
          if (days[i] - days[i - 1] === 86400000) {
            currentStreak += 1;
          } else {
            break;
          }
        }

        const nowDay = toDay(new Date()).getTime();
        const lastDay = days[days.length - 1];
        const anchorDay = lastDay > nowDay ? lastDay : nowDay;
        const daysSince = Math.max(0, Math.round((anchorDay - lastDay) / 86400000));

        const windowStart = anchorDay - 29 * 86400000;
        const daysInWindow = days.filter(
          (dayMs) => dayMs >= windowStart && dayMs <= anchorDay
        ).length;
        const consistency = Math.round((daysInWindow / 30) * 100);

        currentEl.textContent = `${currentStreak} day${currentStreak === 1 ? "" : "s"}`;
        longestEl.textContent = `${longest} day${longest === 1 ? "" : "s"}`;
        consistencyEl.textContent = `${consistency}%`;
        sinceEl.textContent = `${daysSince} day${daysSince === 1 ? "" : "s"}`;
      }

      function buildWeeklyRecap(entries) {
        const hoursEl = document.getElementById("statWeeklyHours");
        const avgEl = document.getElementById("statWeeklyAvg");
        const goalEl = document.getElementById("statWeeklyGoalRate");
        const countEl = document.getElementById("statWeeklyCount");

        if (!hoursEl || !avgEl || !goalEl || !countEl) return;
        if (!entries.length) {
          hoursEl.textContent = "--";
          avgEl.textContent = "--";
          goalEl.textContent = "--";
          countEl.textContent = "--";
          return;
        }

        const nowDay = toDay(new Date()).getTime();
        const latestDay = Math.max(
          ...entries
            .map((entry) => entry.endDate || entry.startDate)
            .filter(Boolean)
            .map((date) => toDay(date).getTime())
        );
        const anchorDay = latestDay > nowDay ? latestDay : nowDay;
        const windowStart = anchorDay - 6 * 86400000;

        const windowEntries = entries.filter((entry) => {
          const baseDate = entry.endDate || entry.startDate;
          if (!baseDate) return false;
          const dayMs = toDay(baseDate).getTime();
          return dayMs >= windowStart && dayMs <= anchorDay;
        });

        const totalHours = windowEntries.reduce(
          (sum, entry) => sum + (entry.durationHours || 0),
          0
        );
        const avgHours = windowEntries.length ? totalHours / windowEntries.length : null;
        const goals = windowEntries.filter((entry) => entry.goalHours !== null);
        const goalHits = goals.filter((entry) => entry.durationHours >= entry.goalHours);
        const goalRate = goals.length ? Math.round((goalHits.length / goals.length) * 100) : null;

        hoursEl.textContent = formatHours(totalHours);
        avgEl.textContent = avgHours !== null ? formatHours(avgHours) : "--";
        goalEl.textContent = goalRate !== null ? `${goalRate}%` : "--";
        countEl.textContent = windowEntries.length.toString();
      }

      function buildHeatmap(entries) {
        const container = document.getElementById("heatmapGrid");
        if (!container) return;
        container.innerHTML = "";
        if (!entries.length) return;

        const dayTotals = new Map();
        entries.forEach((entry) => {
          const baseDate = entry.endDate || entry.startDate;
          if (!baseDate) return;
          const dayMs = toDay(baseDate).getTime();
          const previous = dayTotals.get(dayMs) || 0;
          dayTotals.set(dayMs, previous + (entry.durationHours || 0));
        });

        const days = Array.from(dayTotals.keys());
        if (!days.length) return;
        const nowDay = toDay(new Date()).getTime();
        const lastDay = Math.max(...days);
        const anchorDay = lastDay > nowDay ? lastDay : nowDay;
        const totalDays = 98;
        const startDay = anchorDay - (totalDays - 1) * 86400000;

        for (let i = 0; i < totalDays; i += 1) {
          const dayMs = startDay + i * 86400000;
          const hours = dayTotals.get(dayMs) || 0;
          const level = getHeatLevel(hours);
          const cell = document.createElement("div");
          cell.className = `heatmap-cell heat-${level}`;
          const label = hours
            ? `${formatFullDate(new Date(dayMs))} 路 ${formatHours(hours)}`
            : `${formatFullDate(new Date(dayMs))} 路 No fast`;
          cell.title = label;
          container.appendChild(cell);
        }
      }

      function buildInsights(entries) {
        if (!entries.length) return;

        const totalHours = entries.reduce((sum, entry) => sum + entry.durationHours, 0);
        const average = totalHours / entries.length;
        const longest = Math.max(...entries.map((entry) => entry.durationHours));

        const goals = entries.filter((entry) => entry.goalHours !== null);
        const goalHits = goals.filter((entry) => entry.durationHours >= entry.goalHours);
        const goalRate = goals.length ? (goalHits.length / goals.length) * 100 : null;

        const rolling = entries.slice(-7);
        const rollingAvg =
          rolling.length > 0
            ? rolling.reduce((sum, entry) => sum + entry.durationHours, 0) / rolling.length
            : null;

        const recent = entries[entries.length - 1];

        document.getElementById("statTotal").textContent = entries.length.toString();
        document.getElementById("statAverage").textContent = formatHours(average);
        document.getElementById("statLongest").textContent = formatHours(longest);
        document.getElementById("statGoalRate").textContent = goalRate
          ? `${Math.round(goalRate)}%`
          : "--";
        document.getElementById("statRolling").textContent = formatHours(rollingAvg);
        document.getElementById("statConsistency").textContent = goals.length
          ? `${goalHits.length}/${goals.length} goals`
          : "--";
        document.getElementById("statTotalHours").textContent = formatHours(totalHours);
        document.getElementById("statRecent").textContent = recent
          ? `${formatShortDate(recent.endDate || recent.startDate)} 路 ${formatHours(
              recent.durationHours
            )}`
          : "--";

        document.getElementById("lastUpdated").textContent = formatFullDate(
          recent.endDate || recent.startDate
        );
      }

      function buildRecentTable(entries) {
        const table = document.getElementById("recentTable");
        table.innerHTML = "";
        const recent = entries.slice(-6).reverse();
        recent.forEach((entry) => {
          const row = document.createElement("tr");
          const delta =
            entry.goalHours !== null ? entry.durationHours - entry.goalHours : null;
          row.innerHTML = `
            <td>${formatFullDate(entry.endDate || entry.startDate)}</td>
            <td>${formatHours(entry.durationHours)}</td>
            <td>${entry.goalHours !== null ? formatHours(entry.goalHours) : "--"}</td>
            <td>${delta !== null ? formatDelta(delta) : "--"}</td>
          `;
          table.appendChild(row);
        });
      }

      async function fetchSheetCsv() {
        const urls = [
          `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(
            SHEET_NAME
          )}`,
          `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`,
        ];

        for (const url of urls) {
          try {
            const response = await fetch(url, { cache: "no-store" });
            if (!response.ok) continue;
            const text = await response.text();
            if (text && text.includes(",")) return text;
          } catch (error) {
            console.warn("Sheet fetch failed", error);
          }
        }
        throw new Error("Unable to load sheet data.");
      }

      function normalizeEntries(rows) {
        if (!rows.length) return [];
        const headers = rows[0].map((header) => header.trim());
        const dataRows = rows.slice(1).filter((row) =>
          row.some((cell) => cell && cell.toString().trim())
        );

        const entries = dataRows.map((row) => {
          const record = {};
          headers.forEach((header, index) => {
            record[header] = row[index] ?? "";
          });

          const startDate =
            parseSheetDate(record["Fast Start D+T"]) ||
            combineDateTime(record["Fast Start Date"], record["Fast Start Time"]);
          const endDate =
            parseSheetDate(record["Fast End D+T"]) ||
            combineDateTime(record["Fast End Date"], record["Fast End"]);
          const durationHours =
            parseDurationToHours(record["Duration"]) ||
            (startDate && endDate ? (endDate - startDate) / 36e5 : null);
          const goalHours = parseDurationToHours(record["New Fasting Goal"]);

          return {
            startDate,
            endDate,
            durationHours,
            goalHours,
          };
        });

        return entries
          .filter((entry) => entry.startDate || entry.endDate)
          .sort((a, b) => {
            const aTime = (a.startDate || a.endDate || new Date(0)).getTime();
            const bTime = (b.startDate || b.endDate || new Date(0)).getTime();
            return aTime - bTime;
          });
      }

      function getCurrentFast(entries) {
        const starts = entries.filter((entry) => entry.startDate);
        if (!starts.length) return null;
        const latestStart = starts.reduce((latest, entry) =>
          entry.startDate > latest.startDate ? entry : latest
        );
        const hasEndAfterStart = entries.some(
          (entry) => entry.endDate && entry.endDate >= latestStart.startDate
        );
        return hasEndAfterStart ? null : latestStart;
      }

      function updateCurrentFast(entry) {
        const title = document.getElementById("currentFastTitle");
        const startLabel = document.getElementById("currentFastStart");
        const elapsedEl = document.getElementById("currentFastElapsed");
        const goalEl = document.getElementById("currentFastGoal");
        const deltaEl = document.getElementById("currentFastDelta");
        const progressEl = document.getElementById("currentFastProgress");

        if (!entry || !entry.startDate) {
          title.textContent = "No active fast";
          startLabel.textContent = "--";
          elapsedEl.textContent = "--";
          goalEl.textContent = "Goal: --";
          deltaEl.textContent = "--";
          progressEl.style.width = "0%";
          renderMilestones(null);
          return;
        }

        const now = new Date();
        const elapsedHours = Math.max(0, (now - entry.startDate) / 36e5);
        const goalHours = entry.goalHours;
        const hasGoal = Number.isFinite(goalHours) && goalHours > 0;
        const progress = hasGoal ? Math.min(elapsedHours / goalHours, 1) : 0;
        const remaining = hasGoal ? goalHours - elapsedHours : null;

        title.textContent = "Fast in progress";
        startLabel.textContent = `Started ${formatFullDate(entry.startDate)}`;
        elapsedEl.textContent = formatHours(elapsedHours);
        goalEl.textContent = hasGoal ? `Goal: ${formatHours(goalHours)}` : "Goal: --";
        if (remaining === null) {
          deltaEl.textContent = "Goal not set yet";
        } else if (remaining >= 0) {
          deltaEl.textContent = `${formatHours(remaining)} remaining`;
        } else {
          deltaEl.textContent = `${formatHours(Math.abs(remaining))} past goal`;
        }
        progressEl.style.width = `${Math.round(progress * 100)}%`;
        renderMilestones(elapsedHours);
      }

      async function loadDashboard() {
        setStatus("Loading data...");
        try {
          const csv = await fetchSheetCsv();
          const rows = csvToRows(csv);
          const entries = normalizeEntries(rows);
          const currentFast = getCurrentFast(entries);
          const completedEntries = entries.filter(
            (entry) =>
              entry.durationHours !== null &&
              !Number.isNaN(entry.durationHours) &&
              entry !== currentFast
          );

          if (!entries.length) {
            setStatus("No data found in the sheet.");
            return;
          }

          buildCharts(completedEntries);
          buildTimePatterns(entries);
          buildStreaks(completedEntries);
          buildWeeklyRecap(completedEntries);
          buildHeatmap(completedEntries);
          buildInsights(completedEntries);
          buildRecentTable(completedEntries);
          updateCurrentFast(currentFast);
          setStatus("Live data loaded.");
        } catch (error) {
          console.error(error);
          setStatus("Unable to fetch sheet data.");
        }
      }

      refreshBtn.addEventListener("click", () => loadDashboard());
      loadDashboard();
    </script>
  </body>
</html>
